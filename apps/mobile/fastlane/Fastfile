default_platform(:ios)

before_all do
  ensure_git_status_clean unless ENV["CI"]
end

# ============================================
# iOS
# ============================================
platform :ios do
  desc "iOS: Install certificates and profiles"
  lane :setup_signing do
    # App Store Connect API Key 설정
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )

    # Match를 사용한 코드 서명
    match(
      type: "appstore",
      readonly: true,
      app_identifier: "com.zuraft.pnublace"
    )
  end

  desc "iOS: Build release IPA"
  lane :build do
    setup_signing

    # 버전 자동 증가 (CI에서만)
    if ENV["CI"]
      increment_build_number(
        build_number: ENV["GITHUB_RUN_NUMBER"] || Time.now.strftime("%Y%m%d%H%M"),
        xcodeproj: "ios/PNUBlace.xcodeproj"
      )
    end

    build_app(
      workspace: "ios/PNUBlace.xcworkspace",
      scheme: "PNUBlace",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "PNUBlace.ipa",
      clean: true,
      export_options: {
        provisioningProfiles: {
          "com.zuraft.pnublace" => "match AppStore com.zuraft.pnublace"
        }
      }
    )
  end

  desc "iOS: Upload to TestFlight"
  lane :beta do
    build

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      apple_id: ENV["APPLE_APP_ID"]
    )

    # Slack 알림 (선택)
    if ENV["SLACK_URL"]
      slack(
        message: "iOS 앱이 TestFlight에 업로드되었습니다!",
        success: true,
        slack_url: ENV["SLACK_URL"]
      )
    end
  end

  desc "iOS: Upload to App Store"
  lane :release do
    build

    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false
    )
  end
end

# ============================================
# Android
# ============================================
platform :android do
  desc "Android: Build release AAB"
  lane :build do
    # 버전 코드 자동 증가 (CI에서만)
    if ENV["CI"]
      android_set_version_code(
        version_code: ENV["GITHUB_RUN_NUMBER"].to_i,
        gradle_file: "android/app/build.gradle"
      )
    end

    gradle(
      project_dir: "android",
      task: "bundle",
      build_type: "Release",
      properties: {
        "android.injected.signing.store.file" => ENV["ANDROID_KEYSTORE_PATH"],
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"]
      }
    )
  end

  desc "Android: Build release APK"
  lane :build_apk do
    gradle(
      project_dir: "android",
      task: "assemble",
      build_type: "Release",
      properties: {
        "android.injected.signing.store.file" => ENV["ANDROID_KEYSTORE_PATH"],
        "android.injected.signing.store.password" => ENV["ANDROID_KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["ANDROID_KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["ANDROID_KEY_PASSWORD"]
      }
    )
  end

  desc "Android: Upload to Play Store (Internal Testing)"
  lane :beta do
    build

    upload_to_play_store(
      track: "internal",
      aab: "android/app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    # Slack 알림 (선택)
    if ENV["SLACK_URL"]
      slack(
        message: "Android 앱이 Play Store 내부 테스트에 업로드되었습니다!",
        success: true,
        slack_url: ENV["SLACK_URL"]
      )
    end
  end

  desc "Android: Upload to Play Store (Production)"
  lane :release do
    build

    upload_to_play_store(
      track: "production",
      aab: "android/app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      rollout: "0.1"  # 10% 단계적 출시
    )
  end
end

# ============================================
# Utility
# ============================================
desc "Bump version"
lane :bump_version do |options|
  type = options[:type] || "patch"

  # package.json 버전 업데이트
  package = JSON.parse(File.read("package.json"))
  version_parts = package["version"].split(".")

  case type
  when "major"
    version_parts[0] = (version_parts[0].to_i + 1).to_s
    version_parts[1] = "0"
    version_parts[2] = "0"
  when "minor"
    version_parts[1] = (version_parts[1].to_i + 1).to_s
    version_parts[2] = "0"
  when "patch"
    version_parts[2] = (version_parts[2].to_i + 1).to_s
  end

  new_version = version_parts.join(".")
  package["version"] = new_version
  File.write("package.json", JSON.pretty_generate(package) + "\n")

  UI.success("Version bumped to #{new_version}")
end
